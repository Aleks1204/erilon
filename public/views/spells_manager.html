<!DOCTYPE html>
<html lang="en">
<head>
    <title>Заклинания</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheets/main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
</head>
<body ng-app="spells">

<div ng-controller="spellsController">
    <div data-ng-include data-src="'loader.html'"></div>

    <div data-ng-include data-src="'main-menu.html'"></div>
    <h3 class="text-center">Заклинания</h3>

    <div>
        <div class="panel-group" id="accordion">

            <div class="panel panel-default">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#skills">
                        <div class="panel-heading">
                            Магия
                        </div>
                    </a>
                </h4>

                <div id="skills" class="panel-collapse collapse in">
                    <div class="panel-body">

                        <div ng-repeat="school in schools | orderBy : 'name'">
                            <div class="panel-group">

                                <div class="panel panel-default">
                                    <h4 class="panel-title">
                                        <a data-toggle="collapse" href="#spells{{school.id}}">
                                            <div class="panel-heading">
                                                {{school.name}}
                                            </div>
                                        </a>
                                    </h4>
                                    <div id="spells{{school.id}}" class="panel-collapse collapse in">
                                        <div class="panel-body">
                                            <table class="table table-striped">
                                                <tr>
                                                    <th>Название</th>
                                                    <th>Сложность</th>
                                                    <th>Сложность создания</th>
                                                    <th>Мана</th>
                                                    <th>Поддержание</th>
                                                    <th>Стоимость</th>
                                                    <th></th>
                                                </tr>
                                                <tr ng-repeat="spell in school.Spells | orderBy : 'name'">
                                                    <td style="vertical-align:middle;">
                                                        {{spell.name}}
                                                    </td>
                                                    <td style="vertical-align:middle;">
                                                        {{spell.complexity}}
                                                    </td>
                                                    <td style="vertical-align:middle;">
                                                        {{spell.creating_complexity}}
                                                    </td>
                                                    <td style="vertical-align:middle;">
                                                        {{spell.mana}}
                                                    </td>
                                                    <td style="vertical-align:middle;">
                                                        {{spell.mana_support}} {{spell.mana_sup_time}}
                                                    </td>
                                                    <td style="vertical-align:middle;">
                                                        {{spell.cost}}
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-link" ng-click="deleteSpell(spell.id)">х
                                                        </button>
                                                    </td>
                                                </tr>
                                            </table>
                                            <button type="button" class="btn btn-default pull-right"
                                                    data-toggle="modal" data-target="#addSpellDialog" ng-click="setSchool(school.id)">
                                                Добавить
                                                заклинание
                                            </button>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="addSpellDialog" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Добавить заклинание</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal" role="form"
                          name="addSpellForm">
                        <div class="form-group">
                            <label class="control-label col-sm-3" for="name">Название:</label>

                            <div class="col-sm-9">
                                <input type="text" ng-model="name" class="form-control" id="name" placeholder="Фаербол" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="complexity">Сложность:</label>

                            <div class="col-sm-9">
                                <input type="text" ng-model="complexity" class="form-control" id="complexity" placeholder="5" ng-change="setCreatingComplexity()" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="creating_complexity">Сложность создания:</label>

                            <div class="col-sm-9">
                                <input type="text" ng-model="creating_complexity" class="form-control" id="creating_complexity" placeholder="5" ng-value="{{complexity}}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="mana">Мана:</label>

                            <div class="col-sm-9">
                                <input type="text" ng-model="mana" class="form-control" id="mana" placeholder="5" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="instant">Мгновенное:</label>

                            <div class="col-sm-9">
                                <input type="checkbox" ng-model="instant" class="form-control" id="instant">
                            </div>
                        </div>

                        <div class="form-group" ng-hide="instant">
                            <label class="control-label col-sm-3" for="mana_support">Поддержание:</label>

                            <div class="col-sm-6">
                                <input type="text" ng-model="mana_support" class="form-control" id="mana_support" placeholder="5" ng-required="!instant">
                            </div>
                            <div class="col-sm-3">
                                <select ng-model="mana_sup_time" class="form-control" id="mana_sup_time" ng-required="!instant">
                                    <option value="в раунд" ng-selected="true">в раунд</option>
                                    <option value="в минуту">в минуту</option>
                                    <option value="в час">в час</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="cost">Стоимость:</label>

                            <div class="col-sm-9">
                                <input type="number" ng-model="cost" class="form-control" id="cost" placeholder="1" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="effect">Эффект:</label>

                            <div class="col-sm-9">
                                <textarea ng-model="effect" class="form-control" id="effect" placeholder="Наблюдаемый эффект..." required></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-sm-3" for="description">Описание:</label>

                            <div class="col-sm-9">
                                <textarea ng-model="description" class="form-control" id="description" placeholder="Описание..." required></textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <div class="row">
                                <div class="col-md-offset-7 col-md-2 col-xs-offset-5 col-xs-1">
                                    <button type="button"
                                            class="btn btn-default pull-right"
                                            data-dismiss="modal">
                                        Отмена
                                    </button>
                                </div>

                                <div class="col-md-3 col-xs-1">
                                    <button type="submit"
                                            class="btn btn-success pull-left"
                                            ng-click="addSpell()"
                                            ng-disabled="addSpellForm.$invalid">
                                        Добавить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>


</div>

<script>
    (function (i) {
        var e = /iPhone/i, n = /iPod/i, o = /iPad/i, t = /(?=.*\bAndroid\b)(?=.*\bMobile\b)/i, r = /Android/i, d = /BlackBerry/i, s = /Opera Mini/i, a = /IEMobile/i, b = /(?=.*\bFirefox\b)(?=.*\bMobile\b)/i, h = RegExp("(?:Nexus 7|BNTV250|Kindle Fire|Silk|GT-P1000)", "i"), c = function (i, e) {
            return i.test(e)
        }, l = function (i) {
            var l = i || navigator.userAgent;
            this.apple = {
                phone: c(e, l),
                ipod: c(n, l),
                tablet: c(o, l),
                device: c(e, l) || c(n, l) || c(o, l)
            }, this.android = {
                phone: c(t, l),
                tablet: !c(t, l) && c(r, l),
                device: c(t, l) || c(r, l)
            }, this.other = {
                blackberry: c(d, l),
                opera: c(s, l),
                windows: c(a, l),
                firefox: c(b, l),
                device: c(d, l) || c(s, l) || c(a, l) || c(b, l)
            }, this.seven_inch = c(h, l), this.any = this.apple.device || this.android.device || this.other.device || this.seven_inch
        }, v = i.isMobile = new l;
        v.Class = l
    })(window);

    var app = angular.module("spells", []);

    app.controller("spellsController", function ($scope, $http) {
        $scope.loader = false;
        $scope.isMobile = isMobile.android.phone;
        $scope.instant = false;
        $scope.mana_sup_time = 'в раунд';

        $scope.schools = [];

        $http.get('/attachedSkills').
        success(function (data) {
            angular.forEach(data.attachedSkills, function (attachedSkill) {
                if (attachedSkill.spells_connected) {
                    $scope.schools.push(attachedSkill);
                }
            });
        });

        $scope.setCreatingComplexity = function () {
            $scope.creating_complexity = $scope.complexity;
        };

        $scope.setSchool = function (id) {
            $scope.attached_skill_id = id;
        };

        $scope.addSpell = function () {
            $http.post('/spells', {
                name: $scope.name,
                attached_skill_id: $scope.attached_skill_id,
                complexity: $scope.complexity,
                creating_complexity: $scope.creating_complexity,
                mana: $scope.mana,
                mana_support: $scope.mana_support,
                mana_sup_time: $scope.mana_sup_time,
                cost: $scope.cost,
                instant: $scope.instant,
                effect: $scope.effect,
                description: $scope.description
            }).success(function (data) {
                location.reload();
            });
        };

        $scope.deleteSpell = function (id) {
            $http.delete('/spells/' + id).
            success(function (data) {
                location.reload();
            });
        };

    });

</script>

</body>
</html>